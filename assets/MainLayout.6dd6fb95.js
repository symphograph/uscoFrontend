import{P as _}from"./LocalStorage.0d071f73.js";import{u as O}from"./use-quasar.ed8d67d7.js";import{api as h}from"./axios.62d7d29a.js";import{n as C}from"./myFuncts.20b79409.js";import{u as b,i as M,r as i,p as r,k as x,o as D,l as E,m as H,w as P,n as B,q as L,t as N,f as U,v as F,F as j}from"./index.0a5d15a3.js";import{m as u}from"./myAuth.f2132660.js";import{u as I}from"./use-meta.727adffe.js";const m="SessionToken",d="AccessToken",R={__name:"AuthComponent",setup(q,{expose:T}){const c=O(),y=String("https://api.sakh-orch.ru/");b();const w=M("isOptionsLoaded"),p=M("admin"),A=M("Halls");function k(){console.log("loadOptions started"),h.post(y+"api/get/options.php",{params:{}}).then(t=>{var o,e,a,n;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;A.value=(n=(a=(e=t==null?void 0:t.data)==null?void 0:e.data)==null?void 0:a.Halls)!=null?n:[],console.log("options Loaded"),w.value=!0}).catch(t=>{c.notify(C(t))})}const v=i(""),S=i("");function l(t,o,e="90d"){c.cookies.set(t,o,{expires:e,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t===d&&(h.defaults.headers.common.AccessToken=o,v.value=o,u.self.AccessToken=o),t===m&&(S.value=o,u.self.SessionToken=o)}function f(){h.post(String("https://auth.symphograph.ru/")+"/api/register.php",{params:{authType:"default"}}).then(t=>{var o,e,a,n,s;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;l(d,(a=(e=t==null?void 0:t.data)==null?void 0:e.data.AccessToken)!=null?a:""),l(m,(s=(n=t==null?void 0:t.data)==null?void 0:n.data.SessionToken)!=null?s:""),k()}).catch(t=>{c.notify(C(t))})}r("register",f);function g(){h.post(String("https://auth.symphograph.ru/")+"/api/refresh.php",{params:{SessionToken:u.self.SessionToken,AccessToken:u.self.AccessToken}}).then(t=>{var o,e,a,n,s;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;l(m,(a=(e=t==null?void 0:t.data)==null?void 0:e.data.SessionToken)!=null?a:""),l(d,(s=(n=t==null?void 0:t.data)==null?void 0:n.data.AccessToken)!=null?s:""),p.value=u.self.isPermit([4]),k()}).catch(t=>{var o;if(((o=t==null?void 0:t.response)==null?void 0:o.status)===401){f();return}c.notify(C(t))})}return r("refreshAccessToken",g),T({}),x(()=>{console.log("auth beforeMounted"),h.defaults.headers.common.Accept="application/json",u.self=new u}),D(()=>{console.log("auth Mounted"),!c.cookies.getAll()[d]||!c.cookies.getAll()[m]?f():(l(m,c.cookies.getAll()[m]),l(d,c.cookies.getAll()[d]),g())}),(t,o)=>E("",!0)}};const W={__name:"MainLayout",setup(q){const T=H();I({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}});const y=O(),w=String("https://api.sakh-orch.ru/"),p=b(),A=i(),k=i(!1);r("progress",k);const v=i(!1);r("editMode",v);const S=i(!1);r("admin",S);const l=i(!1);r("leftDrawerOpen",l),i("gfdsg"),i("gfdsg");const f=i(!1);r("isOptionsLoaded",f);const g=i([]);r("Halls",g),P(p,a=>{_.set("lastPath",a.path)});function t(){_.set("CookieConfirm","1")}function o(){_.getItem("CookieConfirm")||y.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:t,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}function e(){h.post(w+"debug/debug.php",{params:{method:"isDebugIp",client:"usso"}}).then(a=>{var n,s;if(!((s=(n=a==null?void 0:a.data)==null?void 0:n.data)!=null&&s.is))throw new Error}).catch(()=>{T.push({path:"/maintenance"})})}return x(()=>{e(),console.log("mainLayout beforeMount")}),D(()=>{_.set("lastPath",p.path),console.log("mainLayout Mounted"),o()}),(a,n)=>{const s=B("router-view");return L(),N(j,null,[U(R,{ref_key:"refAuth",ref:A},null,512),f.value?(L(),F(s,{key:0})):E("",!0)],64)}}};export{W as default};
