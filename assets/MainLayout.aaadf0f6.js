import{u as M}from"./use-quasar.5b03c6bf.js";import{u as O,i as k,p as a,o as x,a as E,c as H,d as N,r as i,w as P,e as j,f as L,g as q,h as D,j as I,F as b}from"./index.f6bac8d8.js";import{P as y}from"./LocalStorage.e7599b54.js";import{api as m}from"./axios.49c9e841.js";import{n as w,c as F,i as C,a as R}from"./myFuncts.8c7f864e.js";import"./jwt-decode.esm.74bd4619.js";const V={__name:"AuthComponent",setup(B,{expose:g}){const s=M(),p=String("https://api.sakh-orch.ru/");O();const T=k("isOptionsLoaded"),_=k("admin"),A=k("Halls");function S(){m.post(p+"api/get/options.php",{params:{}}).then(t=>{var o,e,n,c;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;A.value=(c=(n=(e=t==null?void 0:t.data)==null?void 0:e.data)==null?void 0:n.Halls)!=null?c:[],console.log("options Loaded"),T.value=!0}).catch(t=>{s.notify(w(t))})}const l=k("AccessToken"),f=k("SessionToken");function u(t,o,e="90d"){s.cookies.set(t,o,{expires:e,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t==="AccessToken"&&(m.defaults.headers.common.AccessToken=o,l.value=o,S()),t==="SessionToken"&&(f.value=o)}function d(){m.post(String("https://auth.sakh-orch.ru/")+"/api/register.php",{params:{authType:"default"}}).then(t=>{var o,e,n,c,r;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;u("SessionToken",(n=(e=t==null?void 0:t.data)==null?void 0:e.data.SessionToken)!=null?n:""),u("AccessToken",(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:"")}).catch(t=>{s.notify(w(t))})}a("register",d);function h(){m.post(String("https://auth.sakh-orch.ru/")+"/api/refresh.php",{params:{SessionToken:f.value,AccessToken:l.value}}).then(t=>{var o,e,n,c,r;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;u("SessionToken",(n=(e=t==null?void 0:t.data)==null?void 0:e.data.SessionToken)!=null?n:""),u("AccessToken",(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:""),_.value=F([4],l.value)}).catch(t=>{if(C(t)){d();return}s.notify(w(t))})}a("refreshAccessToken",h);function v(t){return C(t)?(h(),s.notify(R(null,"\u041E\u0439! \u0415\u0449\u0435 \u0440\u0430\u0437, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430.")),!0):!1}return a("refreshIfNeed",v),g({}),x(()=>{console.log("auth beforeMounted"),m.defaults.headers.common.Accept="application/json"}),E(()=>{var t,o,e,n;console.log("auth Mounted"),!s.cookies.getAll().SessionToken||!s.cookies.getAll().AccessToken?d():(f.value=(o=(t=s.cookies.getAll())==null?void 0:t.SessionToken)!=null?o:"",l.value=(n=(e=s.cookies.getAll())==null?void 0:e.AccessToken)!=null?n:"",h())}),(t,o)=>H("",!0)}};const J={__name:"MainLayout",setup(B){N();const g=i();a("pageSettings",g);const s=i(!1);a("isOptionsLoaded",s);const p=i(),T=M();a("q",T);const _=O(),A=i("lvl");a("lvl",A);const S=i("");a("AccessToken",S);const l=i("");a("SessionToken",l);const f=i(!1);a("admin",f);const u=i(!1);a("progress",u);const d=i([]);a("announceList",d);const h=i(!1);a("leftDrawerOpen",h);const v=i([]);a("Halls",v);const t=i(!1);a("editMode",t),P(_,n=>{y.set("lastPath",n.path)});function o(){y.set("CookieConfirm","1")}function e(){y.getItem("CookieConfirm")||T.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:o,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return x(()=>{}),E(()=>{console.log("mainLayout Mounted"),e()}),(n,c)=>{const r=j("router-view");return L(),q(b,null,[D(V,{ref_key:"refAuth",ref:p},null,512),s.value?(L(),I(r,{key:0})):H("",!0)],64)}}};export{J as default};
