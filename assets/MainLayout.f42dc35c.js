import{u as M}from"./use-quasar.06bcebef.js";import{u as O,i as k,p as a,o as x,a as E,c as H,d as N,r as i,w as P,e as j,f as C,g as q,h as D,j as I,F as b}from"./index.788a3604.js";import{P as y}from"./LocalStorage.e46652e2.js";import{api as m}from"./axios.8e8c7da3.js";import{n as w,c as F,i as L,a as R}from"./myFuncts.8c7f864e.js";import"./jwt-decode.esm.74bd4619.js";const V={__name:"AuthComponent",setup(B,{expose:g}){const n=M(),p=String("https://api.sakh-orch.ru/");O();const T=k("isOptionsLoaded"),_=k("admin"),A=k("Halls");function S(){m.post(p+"api/get/options.php",{params:{}}).then(t=>{var o,e,s,c;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;A.value=(c=(s=(e=t==null?void 0:t.data)==null?void 0:e.data)==null?void 0:s.Halls)!=null?c:[],console.log("options Loaded"),T.value=!0}).catch(t=>{n.notify(w(t))})}const r=k("AccessToken"),u=k("SessionToken");function l(t,o,e="90d"){n.cookies.set(t,o,{expires:e,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t==="AccessToken"&&(m.defaults.headers.common.AccessToken=o,r.value=o,S()),t==="SessionToken"&&(u.value=o)}function f(){m.post(String("https://auth.sakh-orch.ru/")+"/api/register.php",{params:{authType:"default"}}).then(t=>{var o,e,s,c,h;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;l("SessionToken",(s=(e=t==null?void 0:t.data)==null?void 0:e.data.SessionToken)!=null?s:""),l("AccessToken",(h=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?h:"")}).catch(t=>{n.notify(w(t))})}a("register",f);function d(){m.post(String("https://auth.sakh-orch.ru/")+"/api/refresh.php",{params:{SessionToken:u.value,AccessToken:r.value}}).then(t=>{var o,e,s,c,h;if(!((o=t==null?void 0:t.data)!=null&&o.result))throw new Error;l("SessionToken",(s=(e=t==null?void 0:t.data)==null?void 0:e.data.SessionToken)!=null?s:""),l("AccessToken",(h=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?h:""),_.value=F([4],r.value)}).catch(t=>{if(L(t)){f();return}n.notify(w(t))})}a("refreshAccessToken",d);function v(t){return L(t)?(d(),n.notify(R(null,"\u041E\u0439! \u0415\u0449\u0435 \u0440\u0430\u0437, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430.")),!0):!1}return a("refreshIfNeed",v),g({}),x(()=>{console.log("auth beforeMounted"),m.defaults.headers.common.Accept="application/json"}),E(()=>{var t,o,e,s;console.log("auth Mounted"),!n.cookies.getAll().SessionToken||!n.cookies.getAll().AccessToken?f():(u.value=(o=(t=n.cookies.getAll())==null?void 0:t.SessionToken)!=null?o:"",r.value=(s=(e=n.cookies.getAll())==null?void 0:e.AccessToken)!=null?s:"",d())}),(t,o)=>H("",!0)}};const J={__name:"MainLayout",setup(B){N();const g=i();a("pageSettings",g);const n=i(!1);a("isOptionsLoaded",n);const p=i(),T=M();a("q",T);const _=O(),A=i("lvl");a("lvl",A);const S=i("");a("AccessToken",S);const r=i("");a("SessionToken",r);const u=i(!1);a("admin",u);const l=i(!1);a("progress",l);const f=i(!1);a("leftDrawerOpen",f);const d=i([]);a("Halls",d);const v=i(!1);a("editMode",v),P(_,e=>{y.set("lastPath",e.path)});function t(){y.set("CookieConfirm","1")}function o(){y.getItem("CookieConfirm")||T.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:t,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return x(()=>{}),E(()=>{console.log("mainLayout Mounted"),o()}),(e,s)=>{const c=j("router-view");return C(),q(b,null,[D(V,{ref_key:"refAuth",ref:p},null,512),n.value?(C(),I(c,{key:0})):H("",!0)],64)}}};export{J as default};
