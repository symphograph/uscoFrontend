import{P as T}from"./LocalStorage.6e33a96e.js";import{u as x}from"./use-quasar.887a5898.js";import{api as k}from"./axios.95308f7a.js";import{n as M,i as H,a as P}from"./myFuncts.9f42497d.js";import{u as E,i as p,p as s,k as B,o as N,l as q,r as i,w as b,m as F,n as O,q as I,f as U,t as j,F as V}from"./index.cd1e76ba.js";import{m as l}from"./myAuth.6afcb8fc.js";import{u as Q}from"./use-meta.1f2e8af7.js";const _="SessionToken",A="AccessToken",R={__name:"AuthComponent",setup(D,{expose:L}){const a=x(),g=String("https://api.sakh-orch.ru/");E();const y=p("isOptionsLoaded"),w=p("admin"),v=p("Halls");function S(){console.log("loadOptions started"),k.post(g+"api/get/options.php",{params:{}}).then(t=>{var e,o,n,c;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;v.value=(c=(n=(o=t==null?void 0:t.data)==null?void 0:o.data)==null?void 0:n.Halls)!=null?c:[],console.log("options Loaded"),y.value=!0}).catch(t=>{a.notify(M(t))})}const f=p("AccessToken"),m=p("SessionToken");function r(t,e,o="90d"){a.cookies.set(t,e,{expires:o,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t===A&&(k.defaults.headers.common.AccessToken=e,f.value=e,l.self.AccessToken=e,S()),t===_&&(m.value=e,l.self.SessionToken=e)}function u(){k.post(String("https://auth.symphograph.ru/")+"/api/register.php",{params:{authType:"default"}}).then(t=>{var e,o,n,c,h;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;r("SessionToken",(n=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?n:""),r("AccessToken",(h=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?h:"")}).catch(t=>{a.notify(M(t))})}s("register",u);function d(){k.post(String("https://auth.symphograph.ru/")+"/api/refresh.php",{params:{SessionToken:m.value,AccessToken:f.value}}).then(t=>{var e,o,n,c,h;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;r("SessionToken",(n=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?n:""),r("AccessToken",(h=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?h:""),w.value=l.self.isPermit([4])}).catch(t=>{var e;if(((e=t==null?void 0:t.response)==null?void 0:e.status)===401){u();return}a.notify(M(t))})}s("refreshAccessToken",d);function C(t){return H(t)?(d(),a.notify(P(null,"\u041E\u0439! \u0415\u0449\u0435 \u0440\u0430\u0437, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430.")),!0):!1}return s("refreshIfNeed",C),L({}),B(()=>{console.log("auth beforeMounted"),k.defaults.headers.common.Accept="application/json",l.self=new l}),N(()=>{var t,e,o,n;console.log("auth Mounted"),!a.cookies.getAll()[A]||!a.cookies.getAll()[_]?u():(m.value=(t=a.cookies.getAll()[_])!=null?t:"",f.value=(e=a.cookies.getAll()[A])!=null?e:"",l.self=new l((o=a.cookies.getAll()[A])!=null?o:"",(n=a.cookies.getAll()[_])!=null?n:""),d())}),(t,e)=>q("",!0)}};const Y={__name:"MainLayout",setup(D){Q({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}});const a=x(),g=E(),y=i(),w=i(!1);s("progress",w);const v=i(!1);s("editMode",v);const S=i(!1);s("admin",S);const f=i(!1);s("leftDrawerOpen",f);const m=i("gfdsg");s("AccessToken",m);const r=i("gfdsg");s("SessionToken",r);const u=i(!1);s("isOptionsLoaded",u);const d=i([]);s("Halls",d),b(g,e=>{T.set("lastPath",e.path)});function C(){T.set("CookieConfirm","1")}function t(){T.getItem("CookieConfirm")||a.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:C,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return N(()=>{T.set("lastPath",g.path),console.log("mainLayout Mounted"),t()}),(e,o)=>{const n=F("router-view");return O(),I(V,null,[U(R,{ref_key:"refAuth",ref:y},null,512),u.value?(O(),j(n,{key:0})):q("",!0)],64)}}};export{Y as default};
