import{u as L}from"./use-quasar.660ae1fa.js";import{u as x,i as m,p as n,o as O,a as E,c as q,d as H,r as i,w as P,e as B,f as C,g as N,h as b,j,F}from"./index.f48fc9c2.js";import{P as g}from"./LocalStorage.3401f363.js";import{u as I}from"./use-meta.cc5c6248.js";import{api as k}from"./axios.f6fea011.js";import{n as S,c as R,i as M,a as U}from"./myFuncts.1e6ef4e3.js";import"./jwt-decode.esm.74bd4619.js";const V={__name:"AuthComponent",setup(D,{expose:_}){const s=L(),v=String("https://api.sakh-orch.ru/");x();const p=m("isOptionsLoaded"),T=m("admin"),A=m("Halls");function y(){k.post(v+"api/get/options.php",{params:{}}).then(t=>{var e,o,a,c;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;A.value=(c=(a=(o=t==null?void 0:t.data)==null?void 0:o.data)==null?void 0:a.Halls)!=null?c:[],console.log("options Loaded"),p.value=!0}).catch(t=>{s.notify(S(t))})}const l=m("AccessToken"),f=m("SessionToken");function u(t,e,o="90d"){s.cookies.set(t,e,{expires:o,path:"/",domain:null,sameSite:"Strict",secure:!0,httpOnly:!1}),t==="AccessToken"&&(k.defaults.headers.common.AccessToken=e,l.value=e,y()),t==="SessionToken"&&(f.value=e)}function d(){k.post(String("https://auth.sakh-orch.ru/")+"/api/register.php",{params:{authType:"default"}}).then(t=>{var e,o,a,c,r;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;u("SessionToken",(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),u("AccessToken",(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:"")}).catch(t=>{s.notify(S(t))})}n("register",d);function h(){k.post(String("https://auth.sakh-orch.ru/")+"/api/refresh.php",{params:{SessionToken:f.value,AccessToken:l.value}}).then(t=>{var e,o,a,c,r;if(!((e=t==null?void 0:t.data)!=null&&e.result))throw new Error;u("SessionToken",(a=(o=t==null?void 0:t.data)==null?void 0:o.data.SessionToken)!=null?a:""),u("AccessToken",(r=(c=t==null?void 0:t.data)==null?void 0:c.data.AccessToken)!=null?r:""),T.value=R([4],l.value)}).catch(t=>{if(M(t)){d();return}s.notify(S(t))})}n("refreshAccessToken",h);function w(t){return M(t)?(h(),s.notify(U(null,"\u041E\u0439! \u0415\u0449\u0435 \u0440\u0430\u0437, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430.")),!0):!1}return n("refreshIfNeed",w),_({}),O(()=>{console.log("auth beforeMounted"),k.defaults.headers.common.Accept="application/json"}),E(()=>{var t,e,o,a;console.log("auth Mounted"),!s.cookies.getAll().SessionToken||!s.cookies.getAll().AccessToken?d():(f.value=(e=(t=s.cookies.getAll())==null?void 0:t.SessionToken)!=null?e:"",l.value=(a=(o=s.cookies.getAll())==null?void 0:o.AccessToken)!=null?a:"",h())}),(t,e)=>q("",!0)}};const X={__name:"MainLayout",setup(D){H();const _=i();n("pageSettings",_);const s=i(!1);n("isOptionsLoaded",s);const v=i(),p=L();n("q",p);const T=x(),A=i("lvl");n("lvl",A);const y=i("");n("AccessToken",y);const l=i("");n("SessionToken",l);const f=i(!1);n("admin",f);const u=i(!1);n("progress",u);const d=i(!1);n("leftDrawerOpen",d);const h=i([]);n("Halls",h);const w=i(!1);n("editMode",w),P(T,a=>{g.set("lastPath",a.path)});function t(){g.set("CookieConfirm","1")}function e(){g.getItem("CookieConfirm")||p.notify({message:"\u041C\u044B \u0442\u043E\u0436\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C Cookies. \u041F\u043E\u0442\u043E\u043C\u0443 \u0447\u0442\u043E \u0431\u0435\u0437 \u043D\u0438\u0445 \u043D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442.",color:"primary",timeout:0,multiLine:!0,onDismiss:t,icon:"ion-information-circle-outline",actions:[{label:"\u041F\u043E\u043D\u044F\u0442\u043D\u043E",color:"yellow",handler:()=>{}}]})}return O(()=>{}),E(()=>{g.set("lastPath",T.path),console.log("mainLayout Mounted"),e()}),I({meta:{viewport:{name:"viewport",content:"initial-scale=1, width=device-width, user-scalable=yes"},equiv:{"http-equiv":"Content-Type",content:"text/html; charset=UTF-8"}}}),(a,c)=>{const r=B("router-view");return C(),N(F,null,[b(V,{ref_key:"refAuth",ref:v},null,512),s.value?(C(),j(r,{key:0})):q("",!0)],64)}}};export{X as default};
